var User={initialize:function(){var e=this;Login.auth(function(){$(".contentpanel").load("admin/user-content-panel",function(){$(".sub-menu-user").addClass("active"),$(".pageheader-h2-icon").attr("class","pageheader-h2-icon"),$(".pageheader-h2-icon").addClass("fa fa-users"),$(".pageheader-h2-text").html(" Users"),$(".pageheader-module").html("Users"),$(".chosen-select").chosen({width:"100%"}),$("#formvalidate").validate({submitHandler:function(a){e.saveOrUpdate(a)}}),$("#btn-cancel").on("click",function(e){e.preventDefault(),$("#userModalForm").modal("hide")}),e.load()})})},load:function(){$("#datatable1").length&&($("#datatable1").dataTable().fnDestroy(),$("#datatable1").show(),$("#datatable1").dataTable({sAjaxSource:"api/users",sAjaxDataProp:"_embedded.users",aoColumns:[{mData:null,sWidth:"5%"},{mData:null,mRender:function(e,a,t){return'<div align="center"><img src="public/images?path='+t.avatarPath+'" height="92px" width="92px" style="padding:3px;border:thin solid #dddddd;border-radius:5px;"></div>'}},{mData:"username"},{mData:"fullname"},{mData:"role"},{mData:null,mRender:function(e,a,t){return t.active?"Active":"Inactive"}},{mData:null,mRender:function(e,a,t){var r=t._links.self.href.split("/"),o=r[r.length-1],i='<a onclick="User.detail('+o+')">Edit</a>';return i+='&nbsp;|&nbsp;<a href="#" onclick="if(confirm(\'Are you sure?\')) {User.delete('+o+');}">Delete</a>'},bSortable:!1}],bServerSide:!0,fnServerData:this.serverDataProcessor,fnRowCallback:function(e,a,t,r){var o=a.pageSize,i=a.pageNum*o+(t+1);return $("td:eq(0)",e).html(i),a.active||$(e).css({"background-color":"#ffaabb"}),e}}),$("#datatable1_wrapper").find("div[id$=_filter]").append(' <label><button class="btn btn-sm btn-primary" onclick="User.createNewUser();">Add User</button>'))},serverDataProcessor:function(e,a,t){for(var r={},o=0;o<a.length;o++)r[a[o].name]=a[o].value;var i=r.iDisplayLength,n=r.iDisplayStart,s=0==n?0:n/i,l=r.iSortCol_0,d=r.sSortDir_0,c=null!=r["mDataProp_"+l]?r["mDataProp_"+l]:"idUser",u=new Array;u.push({name:"size",value:i}),u.push({name:"page",value:s}),u.push({name:"sort",value:c+","+d});var p=e;""!=r.sSearch&&(p="api/users/search/all",u.push({name:"q",value:r.sSearch}));var f=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");$.ajax({dataType:"json",type:"GET",url:p,data:u,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+f)},success:function(e){e.iTotalRecords=e.page.size,e.iTotalDisplayRecords=e.page.totalElements,$.map(e._embedded.users,function(e,a){e.pageNum=s,e.pageSize=i}),t(e)},error:function(e){401==e.status?Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()}):Notification.show("danger","Failed to load user")}})},saveOrUpdate:function(e){var a=this,t={};$(e).serializeArray().map(function(e){t[e.name]=e.value});var r=t.idUser,o=""===r?"POST":"PUT",i=""===r?"api/usercustom":"api/usercustom/"+r,n=$("#avatar")[0],s=new Array("image/jpg","image/jpeg","image/png");if(n.files.length&&-1===$.inArray(n.files[0].type,s))$('label[for="image"]').html("Accepted formats are only jpg, jpeg and png"),$('label[for="image"]').css("display","block");else{var l=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");this.readImage(n.files,function(e){if(void 0!==e){var r=e.replace(/^data:image\/[a-z]+;base64,/,"");t.avatarPath=r,t.avatarPathChanged=!0}else t.avatarPath=$("#old-avatar").val(),t.avatarPathChanged=!1,delete t.old,avatar;t=JSON.stringify(t),$.ajax({dataType:"json",contentType:"application/json",type:o,url:i,data:t,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+l)},success:function(e){e.RESULTS?($("#userModalForm").modal("hide"),Notification.show("success","User saved successfully",function(){a.load()})):Notification.show("danger","Failed to save user")},error:function(e){401==e.status?Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()}):Notification.show("danger","Failed to save user")}})})}},createNewUser:function(){$("#header-title-mode").html("Create New"),$("#header-title").html(""),$("#idUser").val(""),$("#username").val(""),$("#password").val(""),$("#fullname").val(""),$("#role").val(""),$(".avatar-preview").css("display","none"),$("#avatar-image").attr("src",""),$("#avatar-fileupload").attr("class","fileupload fileupload-new"),$(".fileupload-preview").html(""),Notification.hide(),$("#userModalForm").modal("show")},detail:function(e){var a="api/users/"+e,t=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");$.ajax({dataType:"json",type:"GET",url:a,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+t)},success:function(e){var a=e._links.self.href.split("/"),t=a[a.length-1];$.isNumeric(t)&&$("#idUser").val(t),$("#header-title-mode").html("Edit"),$("#header-title").html('"'+e.username+'"'),$("#username").val(e.username),$("#password").val("*******"),$("#fullname").val(e.fullname),$("#role").val(e.role),$("#role").trigger("chosen:updated"),null!=e.avatarPath&&""!==e.avatarPath?($("#avatar-image").attr("src","public/images?path="+e.avatarPath),$(".avatar-preview").css("display","block"),$("#avatar-fileupload").attr("class","fileupload fileupload-new"),$(".fileupload-preview").html(""),$("#old-avatar").val(e.avatarPath)):($(".avatar-preview").css("display","none"),$("#avatar-image").attr("src","")),$("#active").val(e.active?"true":"false"),$("#active").trigger("chosen:updated"),Notification.hide(),$("#userModalForm").modal("show")},error:function(e){401==e.status?Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()}):Notification.show("danger","Failed to load user")}})},delete:function(e){var a=this,t="api/users/"+e,r=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");$.ajax({dataType:"json",contentType:"application/json",type:"DELETE",url:t,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+r)},success:function(e){Notification.show("success","User deleted successfully"),a.load()},error:function(e){401==e.status?Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()}):Notification.show("danger","Failed to delete user")}})},getUrlParameter:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))},readImage:function(e,a){if(e.length){var t=e[0],r=new FileReader;r.onload=function(){data=r.result,a(data)},r.readAsDataURL(t)}else a()}};