var Partner={initialize:function(){var e=this;Login.auth(function(){$(".contentpanel").load("admin/partner-content-panel",function(){$(".sub-menu-partner").addClass("active"),$(".pageheader-h2-icon").attr("class","pageheader-h2-icon"),$(".pageheader-h2-icon").addClass("fa fa-handshake-o"),$(".pageheader-h2-text").html(" Partner"),$(".pageheader-module").html("Partner"),$(".wysihtml5text").wysihtml5({stylesheets:[]}),$("#formvalidate").validate({submitHandler:function(a){e.saveOrUpdate(a)}}),$("#btn-cancel").on("click",function(e){e.preventDefault(),$("#partnerModalForm").modal("hide")}),e.load()})})},load:function(){if($("#datatable1").length){var e=this;$("#datatable1").dataTable().fnDestroy(),$("#datatable1").show(),$("#datatable1").dataTable({sAjaxSource:"api/partner",sAjaxDataProp:"_embedded.partner",aoColumns:[{mData:null,sWidth:"5%"},{mData:null,mRender:function(e,a,t){return'<div align="center"><img src="public/images?path='+t.avatarPath+'" style="width:90px;height:90px;padding:3px;border:thin solid #dddddd;border-radius:5px;"></div>'}},{mData:null,mRender:function(e,a,t){var n=void 0==t.companyName||null==t.companyName?"-":t.companyName+"<br>";return n+=void 0==t.name||null==t.name?"":t.name+"<br>",n+=void 0==t.phone||null==t.phone?"":t.phone+"<br>",n+=void 0==t.phone2||null==t.phone2?"":t.phone2+"<br>",n+=void 0==t.website||null==t.website?"":t.website+"<br>",n+=void 0==t.email||null==t.email?"":t.email+"<br>"}},{mData:"address"},{mData:null,mRender:function(a,t,n){var o=n._links.self.href.split("/"),r=o[o.length-1],i=e.getPosition(n.content,".",3),l='<span id="complete-'+r+'" class="hidden">'+n.content.substring(i)+"</span>",s=' <a href="#" id="read-more-'+r+'" onclick="Partner.readMore('+r+');" style="cursor:pointer;">read more...</a>';return n.content.length>i?n.content.substring(0,i)+l+s:n.content}},{mData:null,mRender:function(e,a,t){var n=t._links.self.href.split("/"),o=n[n.length-1],r='<a onclick="Partner.detail('+o+')">Edit</a>';return r+='&nbsp;|&nbsp;<a href="#" onclick="if(confirm(\'Are you sure?\')) {Partner.delete('+o+');}">Delete</a>'},bSortable:!1}],bServerSide:!0,fnServerData:e.serverDataProcessor,fnRowCallback:function(e,a,t,n){var o=a.pageSize,r=a.pageNum*o+(t+1);return $("td:eq(0)",e).html(r),a.prime&&$(e).css({"background-color":"#001122"}),e}}),$("#datatable1_wrapper").find("div[id$=_filter]").append(' <label><button class="btn btn-sm btn-primary" onclick="Partner.detail();">Add Partner</button>')}},serverDataProcessor:function(e,a,t){for(var n={},o=0;o<a.length;o++)n[a[o].name]=a[o].value;var r=n.iDisplayLength,i=n.iDisplayStart,l=0==i?0:i/r,s=n.iSortCol_0,d=n.sSortDir_0,c=null!=n["mDataProp_"+s]?n["mDataProp_"+s]:"id",p=new Array;p.push({name:"size",value:r}),p.push({name:"page",value:l}),p.push({name:"sort",value:c+","+d});var u=e;""!=n.sSearch&&(u="api/partner/search/all",p.push({name:"q",value:n.sSearch}));var m=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");$.ajax({dataType:"json",type:"GET",url:u,data:p,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+m)},success:function(e){e.iTotalRecords=e.page.size,e.iTotalDisplayRecords=e.page.totalElements,$.map(e._embedded.partner,function(e,a){e.pageNum=l,e.pageSize=r}),t(e)},error:function(e){401==e.status?Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()}):Notification.show("danger","Failed to load partner")}})},saveOrUpdate:function(e){var a=this,t={};$(e).serializeArray().map(function(e){t[e.name]=e.value});var n=t.id,o=$("#avatar")[0],r=new Array("image/jpg","image/jpeg","image/png");if(o.files.length&&-1===$.inArray(o.files[0].type,r))$('label[for="avatar"]').html("Accepted formats are only jpg, jpeg and png"),$('label[for="avatar"]').css("display","block");else{var i=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");a.readImage(o.files,function(e){void 0!==e&&(t.avatarPath=e.replace(/^data:image\/[a-z]+;base64,/,""),t.avatarPathChanged=!0),t=JSON.stringify(t),$.ajax({dataType:"json",contentType:"application/json",type:"PUT",url:"api/partnercustom/"+n,data:t,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+i)},success:function(e){e.RESULTS?($("#partnerModalForm").modal("hide"),Notification.show("success","Partner saved successfully",function(){a.load(),a.loadNotification()})):Notification.show("danger","Failed to save partner")},error:function(e){401==e.status?Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()}):Notification.show("danger","Failed to save partner")}})})}},detail:function(e){if(void 0==e)$("#companyName").val(""),$("#email").val(""),$("#phone").val(""),$("#phone2").val(""),$("#website").val(""),$("#address").data("wysihtml5").editor.setValue(""),$("#address").autogrow(),$("#content").data("wysihtml5").editor.setValue(""),$("#content").autogrow(),$(".avatar-preview").css("display","none"),$("#avatar-image").attr("src",""),$("#approval").attr("checked",!1),$("#partnerModalForm").modal("show");else{var a="api/partner/"+e,t=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");$.ajax({dataType:"json",type:"GET",url:a,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+t)},success:function(e){var a=e._links.self.href.split("/"),t=a[a.length-1];$.isNumeric(t)&&$("#id").val(t),$("#companyName").val(e.companyName),$("#email").val(e.email),$("#phone").val(e.phone),$("#phone2").val(e.phone2),$("#website").val(e.website),$("#address").data("wysihtml5").editor.setValue(e.address),$("#address").autogrow(),$("#content").data("wysihtml5").editor.setValue(e.content),$("#content").autogrow(),null!=e.avatarPath&&""!==e.avatarPath?($("#avatar-image").attr("src","public/images?path="+e.avatarPath),$(".avatar-preview").css("display","block"),$("#avatar-fileupload").attr("class","fileupload fileupload-new"),$(".fileupload-preview").html("")):($(".avatar-preview").css("display","none"),$("#avatar-image").attr("src","")),$("#approval").attr("checked",e.approval),$("#partnerModalForm").modal("show")},error:function(e){401==e.status?Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()}):Notification.show("danger","Failed to load partner")}})}},delete:function(e){var a=this,t="api/partnercustom/"+e,n=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");$.ajax({dataType:"json",contentType:"application/json",type:"DELETE",url:t,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+n)},success:function(e){Notification.show("success","Partner deleted successfully"),a.load()},error:function(e){401==e.status?Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()}):Notification.show("danger","Failed to delete partner")}})},loadNotification:function(){var e=new Array;e.push({name:"q",value:!1});var a=Login.checkLS()?localStorage.getItem("t"):$.cookie("t");$.ajax({dataType:"json",type:"GET",url:"api/partner/search/approval",data:e,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+a)},success:function(e){var a=e.page.totalElements,t="";$(".header-notification-title").html("You Have "+a+" New Partners"),a>0?($(".header-notification-badge").html(a),$.map(e._embedded.partner,function(e,a){t+='<li class="new"><a onclick="Login.loadModule(\'partner\');"><span class="thumb"><img src="public/images?path='+e.avatarPath+'" alt="" /></span><span class="desc"><span class="name">'+e.companyName+" ("+e.website+')<span class="badge badge-success">new</span></span><span class="msg">'+e.email+"</span></span></a></li>"}),t+='<li class="new"><a onclick="Login.loadModule(\'partner\');">See All New Partners</a></li>',$(".header-notification-list").html(t)):$(".header-notification").hide()},error:function(e){401==e.status?Notification.show("danger","Session timed out, please re-login...",function(){Login.logout()}):Notification.show("danger","Failed to load notification")}})},getUrlParameter:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))},readImage:function(e,a){if(e.length){var t=e[0],n=new FileReader;n.onload=function(){data=n.result,a(data)},n.readAsDataURL(t)}else a()},getPosition:function(e,a,t){return e.split(a,t).join(a).length},readMore:function(e){$("#complete-"+e).hasClass("hidden")?($("#complete-"+e).removeClass("hidden"),$("#read-more-"+e).html("hide...")):($("#complete-"+e).addClass("hidden"),$("#read-more-"+e).html("read more..."))}};